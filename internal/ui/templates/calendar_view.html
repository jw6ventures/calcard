{{define "content"}}
<style>
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .calendar-header h1 {
        margin: 0;
        color: var(--gray-900);
    }
    .back-link {
        color: var(--gray-600);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        transition: color 0.2s;
    }
    .back-link:hover { color: var(--primary); }

    .view-toggle {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        background: var(--gray-100);
        padding: 0.25rem;
        border-radius: var(--border-radius);
    }
    .view-btn {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: var(--border-radius);
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
        color: var(--gray-700);
    }
    .view-btn:hover {
        background: var(--gray-200);
    }
    .view-btn.active {
        background: var(--bg-secondary);
        color: var(--primary);
        box-shadow: var(--shadow-sm);
    }
    
    /* Month Calendar View */
    .month-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .month-nav button {
        background: none;
        border: 1px solid var(--border-secondary);
        padding: 0.25rem 0.75rem;
        cursor: pointer;
        border-radius: 4px;
        color: var(--text-primary);
    }
    .month-nav button:hover { background: var(--bg-tertiary); }
    .month-title {
        font-size: 1.25rem;
        font-weight: 600;
        min-width: 200px;
        text-align: center;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: var(--border-primary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        overflow: hidden;
    }
    .calendar-grid .day-header {
        background: var(--bg-tertiary);
        padding: 0.5rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }
    .calendar-grid .day-cell {
        background: var(--bg-secondary);
        min-height: 100px;
        padding: 0.25rem;
        position: relative;
    }
    .calendar-grid .day-cell.other-month {
        background: var(--bg-tertiary);
    }
    .calendar-grid .day-cell.today {
        background: var(--primary);
        background: rgba(59, 130, 246, 0.15);
    }
    .calendar-grid .day-cell.today .day-number {
        color: var(--primary);
        font-weight: 600;
    }
    .day-number {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }
    .day-cell.other-month .day-number {
        color: var(--gray-500);
    }
    .day-events {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .day-event {
        font-size: 0.7rem;
        padding: 2px 4px;
        background: var(--primary);
        color: #fff;
        border-radius: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        transition: background 0.15s;
    }
    .day-event:hover {
        background: var(--primary-dark);
    }
    .day-event.all-day {
        background: var(--secondary);
    }
    .day-event.all-day:hover {
        background: var(--secondary-dark);
    }
    .day-more {
        font-size: 0.65rem;
        color: var(--primary);
        cursor: pointer;
        padding: 2px;
    }
    .day-more:hover {
        text-decoration: underline;
    }
    .day-number.has-events {
        cursor: pointer;
    }
    .day-number.has-events:hover {
        color: var(--primary);
    }
    
    /* Day Events Modal */
    .day-modal-date {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }
    .day-modal-events {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .day-modal-event {
        padding: 0.75rem;
        background: var(--bg-tertiary);
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.15s;
    }
    .day-modal-event:hover {
        background: var(--gray-100);
    }
    .day-modal-event-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }
    .day-modal-event-time {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    .day-modal-event.all-day .day-modal-event-time {
        color: var(--secondary);
    }
    
    /* List View */
    .list-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .list-nav button {
        background: none;
        border: 1px solid var(--border-secondary);
        padding: 0.25rem 0.75rem;
        cursor: pointer;
        border-radius: 4px;
        color: var(--text-primary);
    }
    .list-nav button:hover { background: var(--bg-tertiary); }
    .list-month-title {
        font-size: 1.25rem;
        font-weight: 600;
        min-width: 200px;
        text-align: center;
    }
    .events-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .event-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 1rem;
        transition: box-shadow 0.2s;
        cursor: pointer;
    }
    .event-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .event-date-header {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-700);
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 2px solid var(--border-primary);
    }
    .event-date-header:first-child {
        margin-top: 0;
    }
    .event-title {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    .event-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    .event-meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .event-description {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-primary);
        font-size: 0.875rem;
        color: var(--text-secondary);
        white-space: pre-wrap;
    }
    
    /* Event Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .modal-overlay.show {
        display: flex;
    }
    .modal-content {
        background: var(--bg-secondary);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        max-width: 500px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
        animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .modal-content.modal-lg {
        max-width: 720px;
        width: 95%;
        padding: 1.5rem 2rem;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray-500);
        line-height: 1;
        transition: color 0.2s;
    }
    .modal-close:hover { color: var(--gray-800); }
    .modal-body {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    .modal-body p {
        margin: 0.5rem 0;
    }
    .modal-body strong {
        color: var(--text-primary);
    }
    .event-html-desc {
        padding: 0.5rem;
        background: var(--bg-tertiary);
        border-radius: 4px;
        margin-top: 0.5rem;
        line-height: 1.5;
    }
    .event-html-desc p { margin: 0.5rem 0; }
    .event-html-desc a { color: var(--primary); }
    .reminder-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .reminder-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .reminder-item input {
        width: 120px;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }
    .empty-state h3 {
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
    }
    
    /* Calendar-specific button overrides - base.html handles most button styling */
    .calendar-header .btn {
        font-weight: 500;
    }
    
    /* Form styles - base.html provides most styling */
    .form-group {
        margin-bottom: 1rem;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
        color: var(--gray-700);
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    .form-row .form-group input[type="datetime-local"],
    .form-row .form-group input[type="date"] {
        min-width: 0;
    }
    .form-check {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .form-check input[type="checkbox"] {
        width: auto;
    }
    .form-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-primary);
    }
    
    /* Event actions in modal */
    .modal-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-primary);
    }
</style>

<div class="calendar-header">
    <div>
        <a href="/calendars" class="back-link">&larr; Back to Calendars</a>
        <h1>{{.Calendar.Name}}</h1>
        {{if .Calendar.Shared}}
            <div class="badge">Shared calendar (owner: {{.Calendar.OwnerEmail}})</div>
        {{end}}
    </div>
    <div style="display:flex; gap:0.5rem; align-items:center;">
        <button class="btn btn-primary" onclick="showCreateEventModal()">+ New Event</button>
        {{if .Calendar.Editor}}
        <button class="btn btn-secondary" onclick="showImportModal()">Import ICS</button>
        {{end}}
        {{if .Calendar.Shared}}
        <form method="post" action="/calendars/{{.Calendar.ID}}/shares/{{.User.ID}}/delete" onsubmit="return confirm('Leave this shared calendar?')">
            <input type="hidden" name="_csrf" value="{{.CSRFToken}}">
            <button type="submit" class="btn btn-secondary">Leave</button>
        </form>
        {{end}}
    </div>
</div>

<div class="view-toggle">
    <button class="view-btn active" data-view="month">Month</button>
    <button class="view-btn" data-view="list">List</button>
</div>

<div id="month-view">
    <div class="month-nav">
        <button id="prev-month">&larr;</button>
        <span class="month-title" id="month-title"></span>
        <button id="next-month">&rarr;</button>
        <button id="today-btn" style="margin-left:1rem">Today</button>
    </div>
    <div id="calendar-empty-state" style="display:none; text-align:center; padding:2rem; background: var(--bg-secondary); border-radius: var(--border-radius-lg); margin-bottom:1rem; box-shadow: var(--shadow);">
        <div style="font-size:3rem; margin-bottom:1rem;">ðŸ“…</div>
        <h3 style="color: var(--gray-700); margin-bottom:0.5rem;">No events yet</h3>
        <p style="color: var(--gray-500); margin-bottom:1rem;">Click the "New Event" button above to create your first event</p>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>
</div>

<div id="list-view" style="display:none">
    <div class="list-nav">
        <button id="prev-list-month">&larr;</button>
        <span class="list-month-title" id="list-month-title"></span>
        <button id="next-list-month">&rarr;</button>
        <button id="list-this-month-btn" style="margin-left:1rem">This Month</button>
    </div>
    <div class="events-list" id="events-list"></div>
</div>

<div class="modal-overlay" id="event-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title" id="modal-title"></span>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<div class="modal-overlay" id="day-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title" id="day-modal-title">Events</span>
            <button class="modal-close" id="day-modal-close">&times;</button>
        </div>
        <div class="day-modal-date" id="day-modal-date"></div>
        <div class="day-modal-events" id="day-modal-events"></div>
    </div>
</div>

<!-- Create Event Modal -->
<div class="modal-overlay" id="create-event-modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <span class="modal-title">New Event</span>
            <button class="modal-close" onclick="closeCreateEventModal()">&times;</button>
        </div>
        <form method="POST" action="/calendars/{{.Calendar.ID}}/events">
            <input type="hidden" name="_csrf" value="{{.CSRFToken}}">
            <div class="form-group">
                <label for="create-summary">Title *</label>
                <input type="text" id="create-summary" name="summary" required>
            </div>
            <div class="form-check" style="margin-bottom: 1rem;">
                <input type="checkbox" id="create-all-day" name="all_day" onchange="toggleAllDay('create')">
                <label for="create-all-day" style="margin: 0; font-weight: normal;">All day event</label>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="create-dtstart">Start *</label>
                    <input type="datetime-local" id="create-dtstart" name="dtstart" required>
                </div>
                <div class="form-group">
                    <label for="create-dtend">End *</label>
                    <input type="datetime-local" id="create-dtend" name="dtend" required>
                </div>
            </div>
            <div class="form-group">
                <label for="create-location">Location</label>
                <input type="text" id="create-location" name="location">
            </div>
            <div class="form-group">
                <label for="create-description">Description</label>
                <textarea id="create-description" name="description" rows="2"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="create-timezone">Time zone</label>
                    <input type="text" id="create-timezone" name="timezone" list="timezone-list" placeholder="e.g., America/New_York">
                </div>
                <div class="form-group">
                    <label for="create-status">Status</label>
                    <select id="create-status" name="status">
                        <option value="">None</option>
                        <option value="TENTATIVE">Tentative</option>
                        <option value="CONFIRMED">Confirmed</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="create-visibility">Visibility</label>
                    <select id="create-visibility" name="class">
                        <option value="">Default</option>
                        <option value="PUBLIC">Public</option>
                        <option value="PRIVATE">Private</option>
                        <option value="CONFIDENTIAL">Confidential</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="create-availability">Availability</label>
                    <select id="create-availability" name="transparency">
                        <option value="">Default</option>
                        <option value="OPAQUE">Busy</option>
                        <option value="TRANSPARENT">Free</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="create-url">Link</label>
                <input type="url" id="create-url" name="url" placeholder="https://">
            </div>
            <div class="form-group">
                <label for="create-categories">Categories</label>
                <input type="text" id="create-categories" name="categories" placeholder="e.g., Meeting, Sales">
            </div>
            <div class="form-group">
                <label for="create-organizer">Organizer</label>
                <input type="text" id="create-organizer" name="organizer" placeholder="Name <email@example.com>">
            </div>
            <div class="form-group">
                <label for="create-attendees">Attendees</label>
                <textarea id="create-attendees" name="attendees" rows="2" placeholder="One per line or comma-separated"></textarea>
            </div>
            <div class="form-group">
                <label for="create-attachments">Attachments</label>
                <textarea id="create-attachments" name="attachments" rows="2" placeholder="One URL per line or comma-separated"></textarea>
            </div>
            <div class="form-group">
                <label>Reminders (minutes before)</label>
                <div id="create-reminders" class="reminder-list"></div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addReminderRow('create')">Add reminder</button>
            </div>
            
            <!-- Recurrence Options -->
            <div class="form-group">
                <label for="create-recurrence">Repeat</label>
                <select id="create-recurrence" name="recurrence" onchange="toggleRecurrenceOptions('create')">
                    <option value="">Does not repeat</option>
                    <option value="DAILY">Daily</option>
                    <option value="WEEKLY">Weekly</option>
                    <option value="MONTHLY">Monthly</option>
                    <option value="YEARLY">Yearly</option>
                </select>
            </div>
            <div id="create-recurrence-options" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="create-recurrence-interval">Every</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" id="create-recurrence-interval" name="recurrence_interval" value="1" min="1" max="99" style="width: 70px;">
                            <span id="create-recurrence-unit">day(s)</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="create-recurrence-end">Ends</label>
                        <select id="create-recurrence-end" name="recurrence_end_type" onchange="toggleRecurrenceEnd('create')">
                            <option value="never">Never</option>
                            <option value="after">After</option>
                            <option value="on">On date</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="create-recurrence-byday-group" style="display: none;">
                    <label>Repeat on</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <label><input type="checkbox" name="recurrence_byday" value="MO"> Mon</label>
                        <label><input type="checkbox" name="recurrence_byday" value="TU"> Tue</label>
                        <label><input type="checkbox" name="recurrence_byday" value="WE"> Wed</label>
                        <label><input type="checkbox" name="recurrence_byday" value="TH"> Thu</label>
                        <label><input type="checkbox" name="recurrence_byday" value="FR"> Fri</label>
                        <label><input type="checkbox" name="recurrence_byday" value="SA"> Sat</label>
                        <label><input type="checkbox" name="recurrence_byday" value="SU"> Sun</label>
                    </div>
                </div>
                <div class="form-row" id="create-recurrence-monthly-group" style="display: none;">
                    <div class="form-group">
                        <label for="create-recurrence-bymonthday">Day of month</label>
                        <input type="number" id="create-recurrence-bymonthday" name="recurrence_bymonthday" min="1" max="31">
                    </div>
                    <div class="form-group" id="create-recurrence-bymonth-group" style="display: none;">
                        <label for="create-recurrence-bymonth">Month</label>
                        <select id="create-recurrence-bymonth" name="recurrence_bymonth">
                            <option value="">Any</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>
                <div id="create-recurrence-end-options" style="display: none;">
                    <div class="form-group" id="create-recurrence-count-group" style="display: none;">
                        <label for="create-recurrence-count">Number of occurrences</label>
                        <input type="number" id="create-recurrence-count" name="recurrence_count" value="10" min="1" max="999">
                    </div>
                    <div class="form-group" id="create-recurrence-until-group" style="display: none;">
                        <label for="create-recurrence-until">End date</label>
                        <input type="date" id="create-recurrence-until" name="recurrence_until">
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCreateEventModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Event</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal-overlay" id="edit-event-modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <span class="modal-title">Edit Event</span>
            <button class="modal-close" onclick="closeEditEventModal()">&times;</button>
        </div>
        <form id="edit-event-form" method="POST">
            <input type="hidden" name="_method" value="PUT">
            <input type="hidden" name="_csrf" value="{{.CSRFToken}}">
            <input type="hidden" id="edit-scope" name="edit_scope" value="series">
            <input type="hidden" id="edit-recurrence-id" name="recurrence_id" value="">
            <input type="hidden" id="edit-recurrence-all-day" name="recurrence_all_day" value="">
            <div class="form-group" id="edit-scope-group" style="display: none;">
                <label>Editing</label>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary btn-sm" id="edit-scope-series" onclick="setEditScope('series')">Edit series</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="edit-scope-occurrence" onclick="setEditScope('occurrence')">Edit this occurrence</button>
                </div>
                <div id="edit-scope-hint" style="margin-top: 0.25rem; color: #4a5568; font-size: 0.8rem;"></div>
            </div>
            <div class="form-group">
                <label for="edit-summary">Title *</label>
                <input type="text" id="edit-summary" name="summary" required>
            </div>
            <div class="form-check" style="margin-bottom: 1rem;">
                <input type="checkbox" id="edit-all-day" name="all_day" onchange="toggleAllDay('edit')">
                <label for="edit-all-day" style="margin: 0; font-weight: normal;">All day event</label>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-dtstart">Start *</label>
                    <input type="datetime-local" id="edit-dtstart" name="dtstart" required>
                </div>
                <div class="form-group">
                    <label for="edit-dtend">End *</label>
                    <input type="datetime-local" id="edit-dtend" name="dtend" required>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-location">Location</label>
                <input type="text" id="edit-location" name="location">
            </div>
            <div class="form-group">
                <label for="edit-description">Description</label>
                <textarea id="edit-description" name="description" rows="2"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="edit-timezone">Time zone</label>
                    <input type="text" id="edit-timezone" name="timezone" list="timezone-list" placeholder="e.g., America/New_York">
                </div>
                <div class="form-group">
                    <label for="edit-status">Status</label>
                    <select id="edit-status" name="status">
                        <option value="">None</option>
                        <option value="TENTATIVE">Tentative</option>
                        <option value="CONFIRMED">Confirmed</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-visibility">Visibility</label>
                    <select id="edit-visibility" name="class">
                        <option value="">Default</option>
                        <option value="PUBLIC">Public</option>
                        <option value="PRIVATE">Private</option>
                        <option value="CONFIDENTIAL">Confidential</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-availability">Availability</label>
                    <select id="edit-availability" name="transparency">
                        <option value="">Default</option>
                        <option value="OPAQUE">Busy</option>
                        <option value="TRANSPARENT">Free</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-url">Link</label>
                <input type="url" id="edit-url" name="url" placeholder="https://">
            </div>
            <div class="form-group">
                <label for="edit-categories">Categories</label>
                <input type="text" id="edit-categories" name="categories" placeholder="e.g., Meeting, Sales">
            </div>
            <div class="form-group">
                <label for="edit-organizer">Organizer</label>
                <input type="text" id="edit-organizer" name="organizer" placeholder="Name <email@example.com>">
            </div>
            <div class="form-group">
                <label for="edit-attendees">Attendees</label>
                <textarea id="edit-attendees" name="attendees" rows="2" placeholder="One per line or comma-separated"></textarea>
            </div>
            <div class="form-group">
                <label for="edit-attachments">Attachments</label>
                <textarea id="edit-attachments" name="attachments" rows="2" placeholder="One URL per line or comma-separated"></textarea>
            </div>
            <div class="form-group">
                <label>Reminders (minutes before)</label>
                <div id="edit-reminders" class="reminder-list"></div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addReminderRow('edit')">Add reminder</button>
            </div>
            
            <!-- Recurrence Options -->
            <div class="form-group">
                <label for="edit-recurrence">Repeat</label>
                <select id="edit-recurrence" name="recurrence" onchange="toggleRecurrenceOptions('edit')">
                    <option value="">Does not repeat</option>
                    <option value="DAILY">Daily</option>
                    <option value="WEEKLY">Weekly</option>
                    <option value="MONTHLY">Monthly</option>
                    <option value="YEARLY">Yearly</option>
                </select>
            </div>
            <div id="edit-recurrence-options" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-recurrence-interval">Every</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" id="edit-recurrence-interval" name="recurrence_interval" value="1" min="1" max="99" style="width: 70px;">
                            <span id="edit-recurrence-unit">day(s)</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-recurrence-end">Ends</label>
                        <select id="edit-recurrence-end" name="recurrence_end_type" onchange="toggleRecurrenceEnd('edit')">
                            <option value="never">Never</option>
                            <option value="after">After</option>
                            <option value="on">On date</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="edit-recurrence-byday-group" style="display: none;">
                    <label>Repeat on</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <label><input type="checkbox" name="recurrence_byday" value="MO"> Mon</label>
                        <label><input type="checkbox" name="recurrence_byday" value="TU"> Tue</label>
                        <label><input type="checkbox" name="recurrence_byday" value="WE"> Wed</label>
                        <label><input type="checkbox" name="recurrence_byday" value="TH"> Thu</label>
                        <label><input type="checkbox" name="recurrence_byday" value="FR"> Fri</label>
                        <label><input type="checkbox" name="recurrence_byday" value="SA"> Sat</label>
                        <label><input type="checkbox" name="recurrence_byday" value="SU"> Sun</label>
                    </div>
                </div>
                <div class="form-row" id="edit-recurrence-monthly-group" style="display: none;">
                    <div class="form-group">
                        <label for="edit-recurrence-bymonthday">Day of month</label>
                        <input type="number" id="edit-recurrence-bymonthday" name="recurrence_bymonthday" min="1" max="31">
                    </div>
                    <div class="form-group" id="edit-recurrence-bymonth-group" style="display: none;">
                        <label for="edit-recurrence-bymonth">Month</label>
                        <select id="edit-recurrence-bymonth" name="recurrence_bymonth">
                            <option value="">Any</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>
                <div id="edit-recurrence-end-options" style="display: none;">
                    <div class="form-group" id="edit-recurrence-count-group" style="display: none;">
                        <label for="edit-recurrence-count">Number of occurrences</label>
                        <input type="number" id="edit-recurrence-count" name="recurrence_count" value="10" min="1" max="999">
                    </div>
                    <div class="form-group" id="edit-recurrence-until-group" style="display: none;">
                        <label for="edit-recurrence-until">End date</label>
                        <input type="date" id="edit-recurrence-until" name="recurrence_until">
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-danger" onclick="deleteCurrentEvent()">Delete</button>
                <div style="flex: 1;"></div>
                <button type="button" class="btn btn-secondary" onclick="closeEditEventModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
        <form id="delete-event-form" method="POST" style="display: none;">
            <input type="hidden" name="_csrf" value="{{.CSRFToken}}">
            <input type="hidden" id="delete-edit-scope" name="edit_scope" value="series">
            <input type="hidden" id="delete-recurrence-id" name="recurrence_id" value="">
            <input type="hidden" id="delete-recurrence-all-day" name="recurrence_all_day" value="">
            <input type="hidden" id="delete-timezone" name="timezone" value="">
        </form>
    </div>
</div>

<!-- Import ICS Modal -->
<div class="modal-overlay" id="import-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">Import ICS File</span>
            <button class="modal-close" onclick="closeImportModal()">&times;</button>
        </div>
        <form method="POST" action="/calendars/{{.Calendar.ID}}/import" enctype="multipart/form-data">
            <input type="hidden" name="_csrf" value="{{.CSRFToken}}">
            <div class="form-group">
                <label for="ics-file">Select ICS file *</label>
                <input type="file" id="ics-file" name="ics_file" accept=".ics,.ical" required>
                <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #718096;">
                    Upload an iCalendar (.ics) file to import events into this calendar.
                </p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Import Events</button>
            </div>
        </form>
    </div>
</div>

<datalist id="timezone-list">
    <option value="UTC"></option>
    <option value="America/New_York"></option>
    <option value="America/Chicago"></option>
    <option value="America/Denver"></option>
    <option value="America/Los_Angeles"></option>
    <option value="America/Phoenix"></option>
    <option value="America/Anchorage"></option>
    <option value="Pacific/Honolulu"></option>
    <option value="Europe/London"></option>
    <option value="Europe/Paris"></option>
    <option value="Asia/Tokyo"></option>
</datalist>

<script>
(function() {
    // Calendar ID for API calls
    var calendarID = {{.Calendar.ID}};
    
    // Raw event data from server (loaded via AJAX)
    var rawEvents = [];
    
    // Parse iCalendar data
    function parseICAL(ical) {
        var lines = unfoldLines(ical);
        var components = [];
        var current = [];
        var inEvent = false;

        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            if (line === 'BEGIN:VEVENT') {
                inEvent = true;
                current = [];
                continue;
            }
            if (line === 'END:VEVENT') {
                components.push(current);
                inEvent = false;
                continue;
            }
            if (inEvent) {
                current.push(line);
            }
        }

        function parseEventLines(evLines) {
            var event = {
                attendees: [],
                attachments: [],
                reminders: []
            };
            var inAlarm = false;
            evLines.forEach(function(line) {
                var colonIdx = line.indexOf(':');
                if (colonIdx === -1) return;

                var key = line.substring(0, colonIdx);
                var value = line.substring(colonIdx + 1);

                // Handle parameters in key (e.g., DTSTART;TZID=...)
                var params = {};
                var semicolonIdx = key.indexOf(';');
                if (semicolonIdx !== -1) {
                    var paramStr = key.substring(semicolonIdx + 1);
                    key = key.substring(0, semicolonIdx);
                    paramStr.split(';').forEach(function(p) {
                        var eq = p.indexOf('=');
                        if (eq !== -1) {
                            params[p.substring(0, eq)] = p.substring(eq + 1);
                        }
                    });
                }

                if (key === 'BEGIN' && value === 'VALARM') {
                    inAlarm = true;
                    return;
                }
                if (key === 'END' && value === 'VALARM') {
                    inAlarm = false;
                    return;
                }
                if (inAlarm) {
                    if (key === 'TRIGGER') {
                        var minutes = parseTriggerMinutes(value);
                        if (minutes !== null) {
                            event.reminders.push(minutes);
                        }
                    }
                    return;
                }

                switch (key) {
                    case 'UID':
                        event.uid = value;
                        break;
                    case 'SUMMARY':
                        event.summary = unescapeICAL(value);
                        break;
                    case 'DESCRIPTION':
                        event.description = unescapeICAL(value);
                        break;
                    case 'RECURRENCE-ID':
                        event.recurrenceId = parseICALDate(value, params);
                        event.recurrenceIdAllDay = value.length === 8 || params['VALUE'] === 'DATE';
                        break;
                    case 'X-ALT-DESC':
                        // HTML description from Thunderbird etc.
                        if (params['FMTTYPE'] === 'text/html') {
                            event.htmlDescription = value;
                        }
                        break;
                    case 'LOCATION':
                        event.location = unescapeICAL(value);
                        break;
                    case 'DTSTART':
                        event.dtstart = parseICALDate(value, params);
                        event.allDay = value.length === 8 || params['VALUE'] === 'DATE';
                        if (params['TZID']) event.timezone = params['TZID'];
                        break;
                    case 'DTEND':
                        event.dtend = parseICALDate(value, params);
                        if (!event.timezone && params['TZID']) event.timezone = params['TZID'];
                        break;
                    case 'DURATION':
                        event.duration = value;
                        break;
                    case 'RRULE':
                        event.rrule = value;
                        event.rruleParsed = parseRRule(value);
                        break;
                    case 'EXDATE':
                        event.exdates = event.exdates || [];
                        event.exdates.push(parseICALDate(value, params));
                        break;
                    case 'STATUS':
                        event.status = value;
                        break;
                    case 'CATEGORIES':
                        event.categories = value.split(',').map(function(c) { return c.trim(); });
                        break;
                    case 'URL':
                        event.url = value;
                        break;
                    case 'CLASS':
                        event.class = value;
                        break;
                    case 'TRANSP':
                        event.transp = value;
                        break;
                    case 'ORGANIZER':
                        event.organizer = formatEmailValue(value, params);
                        break;
                    case 'ATTENDEE':
                        event.attendees = event.attendees || [];
                        event.attendees.push(formatEmailValue(value, params));
                        break;
                    case 'ATTACH':
                        event.attachments = event.attachments || [];
                        event.attachments.push(value);
                        break;
                }
            });
            return event;
        }

        var parsedComponents = components.map(parseEventLines);
        var master = parsedComponents.find(function(c) { return !c.recurrenceId; }) || parsedComponents[0] || {};
        var overrides = parsedComponents.filter(function(c) { return c.recurrenceId; });
        overrides.forEach(function(o) {
            if (!o.uid && master.uid) o.uid = master.uid;
        });
        master.overrides = overrides;
        return master;
    }
    
    function unfoldLines(ical) {
        // RFC 5545: lines are folded by inserting CRLF + space/tab
        return ical.replace(/\r\n[ \t]/g, '').replace(/\r\n/g, '\n').split('\n');
    }
    
    function unescapeICAL(str) {
        return str
            .replace(/\\n/gi, '\n')
            .replace(/\\,/g, ',')
            .replace(/\\;/g, ';')
            .replace(/\\\\/g, '\\');
    }

    function formatEmailValue(value, params) {
        var email = value || '';
        if (email.toLowerCase().indexOf('mailto:') === 0) {
            email = email.substring(7);
        }
        var name = params && params['CN'] ? params['CN'] : '';
        if (!email) return '';
        return name ? (name + ' <' + email + '>') : email;
    }

    function parseTriggerMinutes(value) {
        if (!value) return null;
        var sign = 1;
        if (value[0] === '-') {
            sign = -1;
            value = value.substring(1);
        } else if (value[0] === '+') {
            value = value.substring(1);
        }
        var match = value.match(/^P(?:(\d+)D)?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?)?$/);
        if (!match) return null;
        var days = parseInt(match[1] || '0', 10);
        var hours = parseInt(match[2] || '0', 10);
        var mins = parseInt(match[3] || '0', 10);
        var secs = parseInt(match[4] || '0', 10);
        var total = days * 1440 + hours * 60 + mins + Math.round(secs / 60);
        if (sign >= 0) return null;
        return total;
    }
    
    function parseICALDate(str, params) {
        // Handle YYYYMMDD and YYYYMMDDTHHMMSS formats
        str = str.replace('Z', '');
        var year, month, day, hour = 0, min = 0, sec = 0;
        
        if (str.length >= 8) {
            year = parseInt(str.substring(0, 4), 10);
            month = parseInt(str.substring(4, 6), 10) - 1;
            day = parseInt(str.substring(6, 8), 10);
        }
        if (str.length >= 15) {
            hour = parseInt(str.substring(9, 11), 10);
            min = parseInt(str.substring(11, 13), 10);
            sec = parseInt(str.substring(13, 15), 10);
        }
        
        return new Date(year, month, day, hour, min, sec);
    }
    
    // Parse RRULE into structured object
    function parseRRule(rrule) {
        var result = {};
        rrule.split(';').forEach(function(part) {
            var eq = part.indexOf('=');
            if (eq !== -1) {
                var key = part.substring(0, eq);
                var value = part.substring(eq + 1);
                result[key] = value;
            }
        });
        return result;
    }
    
    function makeOccurrenceKey(date, allDay) {
        if (!date) return '';
        if (allDay) {
            var y = date.getFullYear();
            var m = String(date.getMonth() + 1).padStart(2, '0');
            var d = String(date.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + d;
        }
        return String(date.getTime());
    }

    // Expand recurring events into individual occurrences
    function expandRecurringEvents(events, rangeStart, rangeEnd) {
        var expanded = [];
        var maxOccurrences = 500; // Safety limit
        
        events.forEach(function(event) {
            var overrides = event.overrides || [];
            var overrideMap = {};
            overrides.forEach(function(ov) {
                if (!ov.recurrenceId) return;
                var key = makeOccurrenceKey(ov.recurrenceId, ov.recurrenceIdAllDay || ov.allDay || event.allDay);
                // Ensure overrides keep master defaults when fields are missing
                var merged = Object.assign({}, event, ov);
                merged.allDay = ov.allDay !== undefined ? ov.allDay : event.allDay;
                overrideMap[key] = merged;
            });

            if (!event.rrule) {
                // Non-recurring event
                expanded.push(event);
                overrides.forEach(function(ov) {
                    var overrideEv = Object.assign({}, event, ov);
                    overrideEv.recurrenceId = ov.recurrenceId;
                    overrideEv.recurrenceIdAllDay = ov.recurrenceIdAllDay || ov.allDay || event.allDay;
                    expanded.push(overrideEv);
                });
                return;
            }
            
            var rr = event.rruleParsed;
            var freq = rr.FREQ;
            var interval = parseInt(rr.INTERVAL || '1', 10);
            var count = rr.COUNT ? parseInt(rr.COUNT, 10) : null;
            var until = rr.UNTIL ? parseICALDate(rr.UNTIL, {}) : null;
            var byDay = rr.BYDAY ? rr.BYDAY.split(',') : null;
            var byMonthDay = rr.BYMONTHDAY ? rr.BYMONTHDAY.split(',').map(function(d) { return parseInt(d, 10); }) : null;
            var byMonth = rr.BYMONTH ? rr.BYMONTH.split(',').map(function(m) { return parseInt(m, 10); }) : null;
            
            var duration = 0;
            if (event.dtend) {
                duration = event.dtend.getTime() - event.dtstart.getTime();
            }
            
            var exdateSet = {};
            if (event.exdates) {
                event.exdates.forEach(function(d) {
                    exdateSet[makeOccurrenceKey(d, event.allDay)] = true;
                });
            }
            
            var current = new Date(event.dtstart);
            var occurrences = 0;
            var effectiveEnd = until || rangeEnd;
            
            // Generate occurrences within range
            while (occurrences < maxOccurrences) {
                if (count && occurrences >= count) break;
                if (current > effectiveEnd) break;
                
                var matches = true;
                
                // Check BYDAY constraint
                if (byDay) {
                    var dayNames = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                    var currentDay = dayNames[current.getDay()];
                    matches = byDay.some(function(d) { return d.endsWith(currentDay); });
                }
                
                // Check BYMONTHDAY constraint
                if (byMonthDay) {
                    matches = matches && byMonthDay.indexOf(current.getDate()) !== -1;
                }
                
                // Check BYMONTH constraint
                if (byMonth) {
                    matches = matches && byMonth.indexOf(current.getMonth() + 1) !== -1;
                }
                
                // Check EXDATE
                if (exdateSet[makeOccurrenceKey(current, event.allDay)]) {
                    matches = false;
                }
                
                if (matches && current >= rangeStart) {
                    var key = makeOccurrenceKey(current, event.allDay);
                    var override = overrideMap[key];
                    var occurrence;
                    if (override) {
                        occurrence = Object.assign({}, override);
                        occurrence.recurrenceId = override.recurrenceId || new Date(current);
                        occurrence.recurrenceIdAllDay = override.recurrenceIdAllDay || override.allDay || event.allDay;
                    } else {
                        occurrence = Object.assign({}, event);
                        occurrence.dtstart = new Date(current);
                        if (event.dtend) {
                            occurrence.dtend = new Date(current.getTime() + duration);
                        }
                        occurrence.recurrenceId = new Date(current);
                        occurrence.recurrenceIdAllDay = event.allDay;
                    }
                    occurrence.isOccurrence = true;
                    expanded.push(occurrence);
                }
                
                if (matches) occurrences++;
                
                // Advance to next occurrence
                switch (freq) {
                    case 'DAILY':
                        current.setDate(current.getDate() + interval);
                        break;
                    case 'WEEKLY':
                        if (byDay) {
                            // Find next matching day
                            var found = false;
                            for (var attempts = 0; attempts < 7 * interval + 1; attempts++) {
                                current.setDate(current.getDate() + 1);
                                var dayNames = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                                var d = dayNames[current.getDay()];
                                if (byDay.some(function(bd) { return bd.endsWith(d); })) {
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) break;
                        } else {
                            current.setDate(current.getDate() + 7 * interval);
                        }
                        break;
                    case 'MONTHLY':
                        current.setMonth(current.getMonth() + interval);
                        break;
                    case 'YEARLY':
                        current.setFullYear(current.getFullYear() + interval);
                        break;
                    default:
                        current.setDate(current.getDate() + 1);
                }
            }
        });
        
        return expanded;
    }
    
    // Parse all base events
    var baseEvents = [];
    var events = [];
    
    function parseEvents(rawEventsData) {
        baseEvents = rawEventsData.map(function(raw) {
            var parsed = parseICAL(raw.ical);
            parsed.uid = raw.uid;
            parsed.lastMod = raw.lastMod;
            return parsed;
        }).filter(function(e) { return e.dtstart; });
        
        // Keep base events for list view and modals
        events = baseEvents.slice();
        
        // Sort by start date
        events.sort(function(a, b) {
            return a.dtstart - b.dtstart;
        });
        
        window.baseEvents = baseEvents;
    }
    
    // Fetch events for a specific month
    function fetchEventsForMonth(year, month, callback) {
        var url = '/api/calendars/' + calendarID + '/events?year=' + year + '&month=' + month;
        fetch(url)
            .then(function(response) {
                if (!response.ok) throw new Error('Failed to fetch events');
                return response.json();
            })
            .then(function(data) {
                rawEvents = data || [];
                parseEvents(rawEvents);
                if (callback) callback();
            })
            .catch(function(error) {
                console.error('Error fetching events:', error);
                rawEvents = [];
                parseEvents([]);
                if (callback) callback();
            });
    }
    
    // Current view state
    var currentDate = new Date();
    var currentListMonth = new Date();
    var currentView = 'month';
    
    // View toggle
    document.querySelectorAll('.view-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.view-btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            currentView = this.dataset.view;
            
            document.getElementById('month-view').style.display = currentView === 'month' ? 'block' : 'none';
            document.getElementById('list-view').style.display = currentView === 'list' ? 'block' : 'none';
            
            if (currentView === 'list') {
                currentListMonth = new Date();
                fetchEventsForMonth(currentListMonth.getFullYear(), currentListMonth.getMonth() + 1, renderListView);
            }
        });
    });
    
    // Month navigation
    document.getElementById('prev-month').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        fetchEventsForMonth(currentDate.getFullYear(), currentDate.getMonth() + 1, renderMonthView);
    });
    document.getElementById('next-month').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        fetchEventsForMonth(currentDate.getFullYear(), currentDate.getMonth() + 1, renderMonthView);
    });
    document.getElementById('today-btn').addEventListener('click', function() {
        currentDate = new Date();
        fetchEventsForMonth(currentDate.getFullYear(), currentDate.getMonth() + 1, renderMonthView);
    });
    
    // List navigation
    document.getElementById('prev-list-month').addEventListener('click', function() {
        currentListMonth.setMonth(currentListMonth.getMonth() - 1);
        fetchEventsForMonth(currentListMonth.getFullYear(), currentListMonth.getMonth() + 1, renderListView);
    });
    document.getElementById('next-list-month').addEventListener('click', function() {
        currentListMonth.setMonth(currentListMonth.getMonth() + 1);
        fetchEventsForMonth(currentListMonth.getFullYear(), currentListMonth.getMonth() + 1, renderListView);
    });
    document.getElementById('list-this-month-btn').addEventListener('click', function() {
        currentListMonth = new Date();
        fetchEventsForMonth(currentListMonth.getFullYear(), currentListMonth.getMonth() + 1, renderListView);
    });
    
    // Event Modal
    var modal = document.getElementById('event-modal');
    document.getElementById('modal-close').addEventListener('click', function() {
        modal.classList.remove('show');
    });
    modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.classList.remove('show');
    });
    
    // Day Events Modal
    var dayModal = document.getElementById('day-modal');
    document.getElementById('day-modal-close').addEventListener('click', function() {
        dayModal.classList.remove('show');
    });
    dayModal.addEventListener('click', function(e) {
        if (e.target === dayModal) dayModal.classList.remove('show');
    });
    
    function showDayModal(cellDate, dayEvents) {
        var dateOpts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('day-modal-date').textContent = cellDate.toLocaleDateString(undefined, dateOpts);
        document.getElementById('day-modal-title').textContent = dayEvents.length + ' Event' + (dayEvents.length !== 1 ? 's' : '');
        
        var container = document.getElementById('day-modal-events');
        container.innerHTML = '';
        
        // Sort events by time
        dayEvents.sort(function(a, b) {
            if (a.allDay && !b.allDay) return -1;
            if (!a.allDay && b.allDay) return 1;
            return a.dtstart - b.dtstart;
        });
        
        dayEvents.forEach(function(ev) {
            var el = document.createElement('div');
            el.className = 'day-modal-event' + (ev.allDay ? ' all-day' : '');
            
            var title = document.createElement('div');
            title.className = 'day-modal-event-title';
            title.textContent = ev.summary || 'Untitled Event';
            el.appendChild(title);
            
            var time = document.createElement('div');
            time.className = 'day-modal-event-time';
            if (ev.allDay) {
                time.textContent = 'All day';
            } else {
                time.textContent = ev.dtstart.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                if (ev.dtend) {
                    time.textContent += ' - ' + ev.dtend.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                }
            }
            el.appendChild(time);
            
            el.addEventListener('click', function() {
                dayModal.classList.remove('show');
                showEventModal(ev);
            });
            
            container.appendChild(el);
        });
        
        dayModal.classList.add('show');
    }
    
    function showEventModal(event) {
        document.getElementById('modal-title').textContent = event.summary || 'Untitled Event';
        
        var body = '';
        if (event.dtstart) {
            var dateStr = formatDate(event.dtstart, event.allDay);
            if (event.dtend && event.dtend.getTime() !== event.dtstart.getTime()) {
                dateStr += ' - ' + formatDate(event.dtend, event.allDay);
            }
            body += '<p><strong>When:</strong> ' + dateStr + '</p>';
        }
        if (event.location) {
            body += '<p><strong>Where:</strong> ' + escapeHtml(event.location) + '</p>';
        }
        if (event.timezone) {
            body += '<p><strong>Time zone:</strong> ' + escapeHtml(event.timezone) + '</p>';
        }
        if (event.url) {
            var safeUrl = safeHref(event.url);
            var urlLabel = escapeHtml(event.url);
            if (safeUrl) {
                body += '<p><strong>Link:</strong> <a href="' + safeUrl + '" target="_blank" rel="noopener">' + urlLabel + '</a></p>';
            } else {
                body += '<p><strong>Link:</strong> ' + urlLabel + '</p>';
            }
        }
        if (event.status) {
            body += '<p><strong>Status:</strong> ' + escapeHtml(event.status) + '</p>';
        }
        if (event.class) {
            body += '<p><strong>Visibility:</strong> ' + escapeHtml(event.class) + '</p>';
        }
        if (event.transp) {
            var availability = event.transp === 'TRANSPARENT' ? 'Free' : (event.transp === 'OPAQUE' ? 'Busy' : event.transp);
            body += '<p><strong>Availability:</strong> ' + escapeHtml(availability) + '</p>';
        }
        if (event.categories && event.categories.length) {
            body += '<p><strong>Categories:</strong> ' + event.categories.map(escapeHtml).join(', ') + '</p>';
        }
        if (event.organizer) {
            body += '<p><strong>Organizer:</strong> ' + escapeHtml(event.organizer) + '</p>';
        }
        if (event.attendees && event.attendees.length) {
            body += '<p><strong>Attendees:</strong> ' + event.attendees.map(escapeHtml).join(', ') + '</p>';
        }
        if (event.attachments && event.attachments.length) {
            var attLinks = event.attachments.map(function(a) {
                var label = escapeHtml(a);
                var href = safeHref(a);
                if (!href) return label;
                return '<a href="' + href + '" target="_blank" rel="noopener">' + label + '</a>';
            }).join('<br>');
            body += '<p><strong>Attachments:</strong><br>' + attLinks + '</p>';
        }
        if (event.reminders && event.reminders.length) {
            var reminderText = event.reminders.map(function(m) {
                return m + ' min before';
            }).join(', ');
            body += '<p><strong>Reminders:</strong> ' + escapeHtml(reminderText) + '</p>';
        }
        if (event.rrule) {
            body += '<p><strong>Recurrence:</strong> ' + formatRRule(event.rrule) + '</p>';
        }
        if (event.htmlDescription) {
            // Render HTML description (sanitized)
            body += '<p><strong>Description:</strong></p><div class="event-html-desc">' + sanitizeHtml(event.htmlDescription) + '</div>';
        } else if (event.description) {
            body += '<p><strong>Description:</strong></p><p style="white-space:pre-wrap">' + escapeHtml(event.description) + '</p>';
        }
        
        // Add edit button
        body += '<div class="modal-actions">';
        body += '<div id="event-action-buttons"></div>';
        body += '</div>';
        
        document.getElementById('modal-body').innerHTML = body;
        var actionContainer = document.getElementById('event-action-buttons');
        actionContainer.innerHTML = '';
        var masterEvent = window.baseEvents.find(function(e) { return e.uid === event.uid; }) || event;

        function addAction(label, scope, targetEvent) {
            var btn = document.createElement('button');
            btn.className = 'btn btn-primary';
            btn.textContent = label;
            btn.addEventListener('click', function() {
                document.getElementById('event-modal').classList.remove('show');
                showEditEventModal(targetEvent, scope);
            });
            actionContainer.appendChild(btn);
        }

        if (masterEvent && (masterEvent.rrule || event.recurrenceId)) {
            addAction('Edit Series', 'series', masterEvent);
            var occurrenceTarget = event.recurrenceId ? event : masterEvent;
            addAction('Edit Occurrence', 'occurrence', occurrenceTarget);
        } else {
            addAction('Edit Event', 'series', masterEvent);
        }
        modal.classList.add('show');
    }
    
    // Sanitize HTML by allowing only safe tags
    function sanitizeHtml(html) {
        // Unescape iCal escaped characters first
        html = html
            .replace(/\\n/gi, '\n')
            .replace(/\\,/g, ',')
            .replace(/\\;/g, ';')
            .replace(/\\\\/g, '\\');
        
        // Create a temporary element to parse HTML
        var temp = document.createElement('div');
        temp.innerHTML = html;
        
        // Walk the DOM and remove dangerous elements/attributes
        function sanitizeNode(node) {
            if (node.nodeType === Node.ELEMENT_NODE) {
                var tagName = node.tagName.toLowerCase();
                // Allowed tags
                var allowedTags = ['p', 'br', 'b', 'i', 'u', 'strong', 'em', 'a', 'ul', 'ol', 'li', 
                                   'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'pre', 'code',
                                   'div', 'span', 'table', 'tr', 'td', 'th', 'thead', 'tbody'];
                
                if (allowedTags.indexOf(tagName) === -1) {
                    // Replace with its text content
                    var text = document.createTextNode(node.textContent);
                    node.parentNode.replaceChild(text, node);
                    return;
                }
                
                // Remove dangerous attributes
                var attrs = Array.from(node.attributes);
                attrs.forEach(function(attr) {
                    var name = attr.name.toLowerCase();
                    if (name.startsWith('on') || name === 'style' || name === 'class') {
                        node.removeAttribute(attr.name);
                    }
                    if (name === 'href') {
                        var value = attr.value.toLowerCase().trim();
                        if (value.startsWith('javascript:') || value.startsWith('data:')) {
                            node.removeAttribute('href');
                        }
                    }
                });
                
                // Recursively sanitize children
                Array.from(node.childNodes).forEach(sanitizeNode);
            }
        }
        
        Array.from(temp.childNodes).forEach(sanitizeNode);
        return temp.innerHTML;
    }
    
    function formatDate(date, allDay) {
        var opts = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        if (!allDay) {
            opts.hour = '2-digit';
            opts.minute = '2-digit';
        }
        return date.toLocaleDateString(undefined, opts);
    }
    
    function formatRRule(rrule) {
        var rr = {};
        rrule.split(';').forEach(function(part) {
            var eq = part.indexOf('=');
            if (eq !== -1) {
                rr[part.substring(0, eq)] = part.substring(eq + 1);
            }
        });
        
        var freq = (rr.FREQ || '').toLowerCase();
        var interval = parseInt(rr.INTERVAL || '1', 10);
        var result = '';
        
        // Base frequency
        if (interval === 1) {
            switch (freq) {
                case 'daily': result = 'Daily'; break;
                case 'weekly': result = 'Weekly'; break;
                case 'monthly': result = 'Monthly'; break;
                case 'yearly': result = 'Yearly'; break;
                default: result = freq.charAt(0).toUpperCase() + freq.slice(1);
            }
        } else {
            switch (freq) {
                case 'daily': result = 'Every ' + interval + ' days'; break;
                case 'weekly': result = 'Every ' + interval + ' weeks'; break;
                case 'monthly': result = 'Every ' + interval + ' months'; break;
                case 'yearly': result = 'Every ' + interval + ' years'; break;
                default: result = 'Every ' + interval + ' ' + freq;
            }
        }
        
        // BYDAY - days of week
        if (rr.BYDAY) {
            var dayMap = {
                'SU': 'Sunday', 'MO': 'Monday', 'TU': 'Tuesday', 'WE': 'Wednesday',
                'TH': 'Thursday', 'FR': 'Friday', 'SA': 'Saturday'
            };
            var days = rr.BYDAY.split(',').map(function(d) {
                // Handle ordinal days like 1MO, -1FR
                var match = d.match(/^(-?\d*)(\w{2})$/);
                if (match) {
                    var ordinal = match[1];
                    var day = dayMap[match[2]] || match[2];
                    if (ordinal === '1') return '1st ' + day;
                    if (ordinal === '2') return '2nd ' + day;
                    if (ordinal === '3') return '3rd ' + day;
                    if (ordinal === '-1') return 'last ' + day;
                    if (ordinal) return ordinal + 'th ' + day;
                    return day;
                }
                return d;
            });
            result += ' on ' + days.join(', ');
        }
        
        // BYMONTHDAY
        if (rr.BYMONTHDAY) {
            result += ' on day ' + rr.BYMONTHDAY;
        }
        
        // BYMONTH
        if (rr.BYMONTH) {
            var monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            var months = rr.BYMONTH.split(',').map(function(m) {
                return monthNames[parseInt(m, 10)] || m;
            });
            result += ' in ' + months.join(', ');
        }
        
        // COUNT or UNTIL
        if (rr.COUNT) {
            result += ', ' + rr.COUNT + ' times';
        } else if (rr.UNTIL) {
            var until = parseICALDate(rr.UNTIL, {});
            result += ', until ' + until.toLocaleDateString();
        }
        
        return result;
    }
    
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function safeHref(raw) {
        if (!raw) return '';
        var value = String(raw).trim();
        if (!value) return '';
        try {
            var u = new URL(value, window.location.origin);
            var protocol = (u.protocol || '').toLowerCase();
            if (protocol === 'http:' || protocol === 'https:' || protocol === 'mailto:') {
                return escapeHtml(value);
            }
        } catch (e) {}
        return '';
    }
    
    // Expanded events for calendar view (includes recurring occurrences)
    var expandedEvents = [];
    
    function renderMonthView() {
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth();

        document.getElementById('month-title').textContent =
            currentDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });

        // Expand recurring events for this month's range (with some padding)
        var rangeStart = new Date(year, month - 1, 1);
        var rangeEnd = new Date(year, month + 2, 0);
        expandedEvents = expandRecurringEvents(baseEvents, rangeStart, rangeEnd);

        // Show/hide empty state
        var emptyState = document.getElementById('calendar-empty-state');
        if (baseEvents.length === 0) {
            emptyState.style.display = 'block';
        } else {
            emptyState.style.display = 'none';
        }

        var grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        
        // Day headers
        var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        days.forEach(function(d) {
            var el = document.createElement('div');
            el.className = 'day-header';
            el.textContent = d;
            grid.appendChild(el);
        });
        
        // Get first day of month and total days
        var firstDay = new Date(year, month, 1);
        var lastDay = new Date(year, month + 1, 0);
        var startDayOfWeek = firstDay.getDay();
        var totalDays = lastDay.getDate();
        
        // Previous month padding
        var prevMonthDays = new Date(year, month, 0).getDate();
        for (var i = startDayOfWeek - 1; i >= 0; i--) {
            createDayCell(grid, prevMonthDays - i, year, month - 1, true);
        }
        
        // Current month
        var today = new Date();
        for (var d = 1; d <= totalDays; d++) {
            var isToday = (year === today.getFullYear() && month === today.getMonth() && d === today.getDate());
            createDayCell(grid, d, year, month, false, isToday);
        }
        
        // Next month padding
        var totalCells = startDayOfWeek + totalDays;
        var remaining = (7 - (totalCells % 7)) % 7;
        for (var n = 1; n <= remaining; n++) {
            createDayCell(grid, n, year, month + 1, true);
        }
    }
    
    function createDayCell(grid, day, year, month, otherMonth, isToday) {
        var cell = document.createElement('div');
        cell.className = 'day-cell';
        if (otherMonth) cell.className += ' other-month';
        if (isToday) cell.className += ' today';
        
        // Find events for this day from expanded events
        var cellDate = new Date(year, month, day);
        var cellDateStr = cellDate.toDateString();
        var dayEvents = expandedEvents.filter(function(e) {
            var start = new Date(e.dtstart.getFullYear(), e.dtstart.getMonth(), e.dtstart.getDate());
            var end;
            if (e.dtend) {
                end = new Date(e.dtend.getFullYear(), e.dtend.getMonth(), e.dtend.getDate());
                // For all-day events, DTEND is exclusive (day after the last day)
                // So we need to subtract one day for comparison
                if (e.allDay && end > start) {
                    end.setDate(end.getDate() - 1);
                }
            } else {
                end = start;
            }
            return cellDate >= start && cellDate <= end;
        });
        
        var numEl = document.createElement('div');
        numEl.className = 'day-number';
        if (dayEvents.length > 0) {
            numEl.className += ' has-events';
            numEl.addEventListener('click', function(e) {
                e.stopPropagation();
                showDayModal(cellDate, dayEvents);
            });
        }
        numEl.textContent = day;
        cell.appendChild(numEl);
        
        var eventsEl = document.createElement('div');
        eventsEl.className = 'day-events';
        
        // Show first 3 events
        var maxShow = 3;
        dayEvents.slice(0, maxShow).forEach(function(ev) {
            var evEl = document.createElement('div');
            evEl.className = 'day-event' + (ev.allDay ? ' all-day' : '');
            evEl.textContent = ev.summary || 'Untitled';
            if (ev.isOccurrence) {
                evEl.title = 'Recurring event';
            }
            evEl.addEventListener('click', function(e) {
                e.stopPropagation();
                showEventModal(ev);
            });
            eventsEl.appendChild(evEl);
        });
        
        if (dayEvents.length > maxShow) {
            var more = document.createElement('div');
            more.className = 'day-more';
            more.textContent = '+' + (dayEvents.length - maxShow) + ' more';
            more.addEventListener('click', function(e) {
                e.stopPropagation();
                showDayModal(cellDate, dayEvents);
            });
            eventsEl.appendChild(more);
        }
        
        cell.appendChild(eventsEl);
        grid.appendChild(cell);
    }
    
    function renderListView() {
        var list = document.getElementById('events-list');
        
        // Update month title
        var monthOpts = { month: 'long', year: 'numeric' };
        document.getElementById('list-month-title').textContent = currentListMonth.toLocaleDateString(undefined, monthOpts);
        
        // Expand recurring events for the selected month (with some padding)
        var year = currentListMonth.getFullYear();
        var month = currentListMonth.getMonth();
        var rangeStart = new Date(year, month - 1, 1);
        var rangeEnd = new Date(year, month + 2, 0);
        var expandedForList = expandRecurringEvents(baseEvents, rangeStart, rangeEnd);
        
        // Filter events for the selected month
        var monthEvents = expandedForList.filter(function(e) {
            var start = new Date(e.dtstart.getFullYear(), e.dtstart.getMonth(), e.dtstart.getDate());
            var end;
            if (e.dtend) {
                end = new Date(e.dtend.getFullYear(), e.dtend.getMonth(), e.dtend.getDate());
                // For all-day events, DTEND is exclusive
                if (e.allDay && end > start) {
                    end.setDate(end.getDate() - 1);
                }
            } else {
                end = start;
            }
            // Event is in month if it starts in month or overlaps with month
            return (start.getFullYear() === year && start.getMonth() === month) ||
                   (end.getFullYear() === year && end.getMonth() === month) ||
                   (start < new Date(year, month, 1) && end >= new Date(year, month + 1, 0));
        });
        
        // Sort by date and time
        monthEvents.sort(function(a, b) {
            var dateCompare = a.dtstart - b.dtstart;
            if (dateCompare !== 0) return dateCompare;
            if (a.allDay && !b.allDay) return -1;
            if (!a.allDay && b.allDay) return 1;
            return 0;
        });
        
        if (monthEvents.length === 0) {
            list.innerHTML = '<div class="empty-state"><h3>No Events</h3><p>No events scheduled for this month.</p></div>';
            return;
        }
        
        // Group events by day
        list.innerHTML = '';
        var currentDayStr = '';
        
        monthEvents.forEach(function(ev) {
            var evDayStr = ev.dtstart.toDateString();
            
            // Add date header if this is a new day
            if (evDayStr !== currentDayStr) {
                currentDayStr = evDayStr;
                var dateHeader = document.createElement('div');
                dateHeader.className = 'event-date-header';
                var headerOpts = { weekday: 'long', month: 'long', day: 'numeric' };
                dateHeader.textContent = ev.dtstart.toLocaleDateString(undefined, headerOpts);
                list.appendChild(dateHeader);
            }
            
            var card = document.createElement('div');
            card.className = 'event-card';
            
            var title = document.createElement('div');
            title.className = 'event-title';
            title.textContent = ev.summary || 'Untitled Event';
            card.appendChild(title);
            
            var meta = document.createElement('div');
            meta.className = 'event-meta';
            
            if (ev.dtstart) {
                var dateItem = document.createElement('span');
                dateItem.className = 'event-meta-item';
                if (ev.allDay) {
                    dateItem.textContent = 'All day';
                } else {
                    dateItem.textContent = ev.dtstart.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                    if (ev.dtend) {
                        dateItem.textContent += ' - ' + ev.dtend.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                    }
                }
                meta.appendChild(dateItem);
            }
            if (ev.location) {
                var locItem = document.createElement('span');
                locItem.className = 'event-meta-item';
                locItem.textContent = ev.location;
                meta.appendChild(locItem);
            }
            if (ev.isOccurrence) {
                var recurItem = document.createElement('span');
                recurItem.className = 'event-meta-item';
                recurItem.textContent = 'ðŸ” Recurring';
                recurItem.style.color = 'var(--primary)';
                meta.appendChild(recurItem);
            }
            card.appendChild(meta);
            
            if (ev.description) {
                var desc = document.createElement('div');
                desc.className = 'event-description';
                desc.textContent = ev.description;
                card.appendChild(desc);
            }
            
            card.addEventListener('click', function() {
                showEventModal(ev);
            });
            
            list.appendChild(card);
        });
    }
    
    // Initial load - fetch events for current month
    fetchEventsForMonth(currentDate.getFullYear(), currentDate.getMonth() + 1, function() {
        renderMonthView();
    });
    
    // Check for ?event=UID query parameter to open specific event
    var urlParams = new URLSearchParams(window.location.search);
    var eventUid = urlParams.get('event');
    if (eventUid) {
        var targetEvent = baseEvents.find(function(e) { return e.uid === eventUid; });
        if (targetEvent) {
            setTimeout(function() {
                showEventModal(targetEvent);
            }, 100);
        }
    }
    
    // Store current event for editing
    window.currentEditEvent = null;
    
    // Make showEventModal accessible globally for edit functionality
    window.showEventModal = showEventModal;
    window.baseEvents = baseEvents;
})();

// Create Event Modal
function showCreateEventModal() {
    document.getElementById('create-event-modal').classList.add('show');
    document.getElementById('create-summary').focus();
    var tzInput = document.getElementById('create-timezone');
    if (tzInput && !tzInput.value) {
        try {
            tzInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
        } catch (e) {}
    }
    setReminderList('create', null, true);
}

function closeCreateEventModal() {
    document.getElementById('create-event-modal').classList.remove('show');
    document.getElementById('create-summary').value = '';
    document.getElementById('create-dtstart').value = '';
    document.getElementById('create-dtend').value = '';
    document.getElementById('create-location').value = '';
    document.getElementById('create-description').value = '';
    document.getElementById('create-timezone').value = '';
    document.getElementById('create-status').value = '';
    document.getElementById('create-visibility').value = '';
    document.getElementById('create-availability').value = '';
    document.getElementById('create-url').value = '';
    document.getElementById('create-categories').value = '';
    document.getElementById('create-organizer').value = '';
    document.getElementById('create-attendees').value = '';
    document.getElementById('create-attachments').value = '';
    document.getElementById('create-all-day').checked = false;
    setReminderList('create', [], false);
}

// Edit Event Modal
function showEditEventModal(event, scope) {
    if (!event || !event.uid) {
        alert('Event data unavailable for editing.');
        return;
    }
    window.currentEditEvent = event;
    var effectiveScope = scope || (event && event.recurrenceId ? 'occurrence' : 'series');
    var calendarId = {{.Calendar.ID}};
    document.getElementById('edit-event-form').action = '/calendars/' + calendarId + '/events/' + encodeURIComponent(event.uid);
    document.getElementById('delete-event-form').action = '/calendars/' + calendarId + '/events/' + encodeURIComponent(event.uid) + '/delete';
    
    document.getElementById('edit-summary').value = event.summary || '';
    document.getElementById('edit-location').value = event.location || '';
    document.getElementById('edit-description').value = event.description || '';
    document.getElementById('edit-timezone').value = event.timezone || '';
    document.getElementById('edit-status').value = event.status || '';
    document.getElementById('edit-visibility').value = event.class || '';
    document.getElementById('edit-availability').value = event.transp || '';
    document.getElementById('edit-url').value = event.url || '';
    document.getElementById('edit-categories').value = (event.categories || []).join(', ');
    document.getElementById('edit-organizer').value = event.organizer || '';
    document.getElementById('edit-attendees').value = (event.attendees || []).join('\n');
    document.getElementById('edit-attachments').value = (event.attachments || []).join('\n');
    setReminderList('edit', event.reminders || [], false);
    document.getElementById('delete-timezone').value = event.timezone || '';
    document.getElementById('edit-all-day').checked = event.allDay || false;
    toggleAllDay('edit', true);
    
    if (event.dtstart) {
        if (event.allDay) {
            document.getElementById('edit-dtstart').value = formatDateForInput(event.dtstart);
        } else {
            document.getElementById('edit-dtstart').value = formatDateTimeForInput(event.dtstart);
        }
    } else {
        document.getElementById('edit-dtstart').value = '';
    }
    
    if (event.dtend) {
        if (event.allDay) {
            // For all-day, DTEND is exclusive so subtract a day for display
            var displayEnd = new Date(event.dtend);
            displayEnd.setDate(displayEnd.getDate() - 1);
            document.getElementById('edit-dtend').value = formatDateForInput(displayEnd);
        } else {
            document.getElementById('edit-dtend').value = formatDateTimeForInput(event.dtend);
        }
    } else {
        document.getElementById('edit-dtend').value = '';
    }
    
    // Populate recurrence fields
    var recurrenceSelect = document.getElementById('edit-recurrence');
    var intervalInput = document.getElementById('edit-recurrence-interval');
    var endTypeSelect = document.getElementById('edit-recurrence-end');
    var countInput = document.getElementById('edit-recurrence-count');
    var untilInput = document.getElementById('edit-recurrence-until');
    var byMonthDayInput = document.getElementById('edit-recurrence-bymonthday');
    var byMonthSelect = document.getElementById('edit-recurrence-bymonth');
    var byDayCheckboxes = document.querySelectorAll('#edit-recurrence-byday-group input[type="checkbox"]');
    
    // Reset recurrence fields to defaults
    recurrenceSelect.value = '';
    intervalInput.value = '1';
    endTypeSelect.value = 'never';
    countInput.value = '10';
    untilInput.value = '';
    if (byMonthDayInput) byMonthDayInput.value = '';
    if (byMonthSelect) byMonthSelect.value = '';
    byDayCheckboxes.forEach(function(cb) { cb.checked = false; });
    
    if (event.rruleParsed) {
        var rr = event.rruleParsed;
        
        // Set frequency
        if (rr.FREQ) {
            recurrenceSelect.value = rr.FREQ;
        }
        
        // Set interval
        if (rr.INTERVAL) {
            intervalInput.value = rr.INTERVAL;
        }
        
        // Set end type and value
        if (rr.COUNT) {
            endTypeSelect.value = 'after';
            countInput.value = rr.COUNT;
        } else if (rr.UNTIL) {
            endTypeSelect.value = 'on';
            // Parse UNTIL date (format: YYYYMMDD or YYYYMMDDTHHMMSSZ)
            var until = rr.UNTIL.replace('Z', '');
            if (until.length >= 8) {
                var year = until.substring(0, 4);
                var month = until.substring(4, 6);
                var day = until.substring(6, 8);
                untilInput.value = year + '-' + month + '-' + day;
            }
        }
        if (rr.BYDAY) {
            var days = rr.BYDAY.split(',');
            byDayCheckboxes.forEach(function(cb) {
                cb.checked = days.indexOf(cb.value) !== -1;
            });
        }
        if (rr.BYMONTHDAY && byMonthDayInput) {
            byMonthDayInput.value = rr.BYMONTHDAY.split(',')[0];
        }
        if (rr.BYMONTH && byMonthSelect) {
            byMonthSelect.value = rr.BYMONTH.split(',')[0];
        }
    }
    
    // Update UI to show/hide recurrence options
    toggleRecurrenceOptions('edit');
    toggleRecurrenceEnd('edit');
    
    toggleAllDay('edit');
    var scopeGroup = document.getElementById('edit-scope-group');
    if (event.rrule || event.recurrenceId) {
        scopeGroup.style.display = 'block';
    } else {
        scopeGroup.style.display = 'none';
        effectiveScope = 'series';
    }
    setEditScope(effectiveScope, event);
    document.getElementById('edit-event-modal').classList.add('show');
}

function closeEditEventModal() {
    document.getElementById('edit-event-modal').classList.remove('show');
    window.currentEditEvent = null;
}

function formatRecurrenceIdForInput(date, allDay) {
    if (!date) return '';
    return allDay ? formatDateForInput(date) : formatDateTimeForInput(date);
}

function setEditScope(scope, event) {
    if (!event) event = window.currentEditEvent;
    var seriesBtn = document.getElementById('edit-scope-series');
    var occBtn = document.getElementById('edit-scope-occurrence');
    var hint = document.getElementById('edit-scope-hint');
    var recurrenceIdInput = document.getElementById('edit-recurrence-id');
    var recurrenceAllDayInput = document.getElementById('edit-recurrence-all-day');
    var deleteRecurrenceIdInput = document.getElementById('delete-recurrence-id');
    var deleteRecurrenceAllDayInput = document.getElementById('delete-recurrence-all-day');
    var deleteBtn = document.querySelector('#edit-event-form .btn.btn-danger');
    var recurrenceSelect = document.getElementById('edit-recurrence');

    document.getElementById('edit-scope').value = scope;
    document.getElementById('delete-edit-scope').value = scope;
    recurrenceSelect.disabled = scope === 'occurrence';

    seriesBtn.classList.remove('btn-primary');
    occBtn.classList.remove('btn-primary');
    seriesBtn.classList.remove('btn-secondary');
    occBtn.classList.remove('btn-secondary');
    seriesBtn.classList.add(scope === 'series' ? 'btn-primary' : 'btn-secondary');
    occBtn.classList.add(scope === 'occurrence' ? 'btn-primary' : 'btn-secondary');

    if (scope === 'occurrence' && event) {
        var recDate = event.recurrenceId || event.dtstart;
        var allDay = event.recurrenceIdAllDay || event.allDay;
        var formatted = formatRecurrenceIdForInput(recDate, allDay);
        recurrenceIdInput.value = formatted;
        recurrenceAllDayInput.value = allDay ? 'true' : 'false';
        deleteRecurrenceIdInput.value = formatted;
        deleteRecurrenceAllDayInput.value = allDay ? 'true' : 'false';
        hint.textContent = 'Changes apply only to this occurrence.';
        if (deleteBtn) deleteBtn.textContent = 'Delete occurrence';
    } else {
        recurrenceIdInput.value = '';
        recurrenceAllDayInput.value = '';
        deleteRecurrenceIdInput.value = '';
        deleteRecurrenceAllDayInput.value = '';
        hint.textContent = scope === 'series' ? 'Changes apply to the entire series.' : '';
        if (deleteBtn) deleteBtn.textContent = 'Delete event';
    }
    var tzInput = document.getElementById('edit-timezone');
    var deleteTz = document.getElementById('delete-timezone');
    if (tzInput && deleteTz) {
        deleteTz.value = tzInput.value || '';
    }
}

function deleteCurrentEvent() {
    var scope = document.getElementById('edit-scope').value || 'series';
    var message = scope === 'occurrence'
        ? 'Delete just this occurrence? The series will remain.'
        : 'Delete the entire series/event?';
    if (confirm(message)) {
        document.getElementById('delete-event-form').submit();
    }
}

function toggleAllDay(prefix, preserveValues) {
    var checkbox = document.getElementById(prefix + '-all-day');
    var startInput = document.getElementById(prefix + '-dtstart');
    var endInput = document.getElementById(prefix + '-dtend');
    
    if (checkbox.checked) {
        // Switch to date-only inputs
        var startVal = startInput.value;
        var endVal = endInput.value;
        startInput.type = 'date';
        endInput.type = 'date';
        if (!preserveValues) {
            if (startVal) startInput.value = startVal.split('T')[0];
            if (endVal) endInput.value = endVal.split('T')[0];
        }
    } else {
        // Switch to datetime-local inputs
        var startVal = startInput.value;
        var endVal = endInput.value;
        startInput.type = 'datetime-local';
        endInput.type = 'datetime-local';
        if (!preserveValues) {
            if (startVal) {
                startInput.value = startVal.indexOf('T') === -1 ? startVal + 'T09:00' : startVal;
            }
            if (endVal) {
                endInput.value = endVal.indexOf('T') === -1 ? endVal + 'T10:00' : endVal;
            }
        }
    }
}

function formatDateForInput(date) {
    var year = date.getFullYear();
    var month = String(date.getMonth() + 1).padStart(2, '0');
    var day = String(date.getDate()).padStart(2, '0');
    return year + '-' + month + '-' + day;
}

function formatDateTimeForInput(date) {
    var year = date.getFullYear();
    var month = String(date.getMonth() + 1).padStart(2, '0');
    var day = String(date.getDate()).padStart(2, '0');
    var hours = String(date.getHours()).padStart(2, '0');
    var minutes = String(date.getMinutes()).padStart(2, '0');
    return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
}

// Recurrence options
function toggleRecurrenceOptions(prefix) {
    var select = document.getElementById(prefix + '-recurrence');
    var optionsDiv = document.getElementById(prefix + '-recurrence-options');
    var unitSpan = document.getElementById(prefix + '-recurrence-unit');
    
    if (select.value) {
        optionsDiv.style.display = 'block';
        var units = {
            'DAILY': 'day(s)',
            'WEEKLY': 'week(s)',
            'MONTHLY': 'month(s)',
            'YEARLY': 'year(s)'
        };
        unitSpan.textContent = units[select.value] || 'time(s)';
    } else {
        optionsDiv.style.display = 'none';
    }
    updateRecurrenceDetails(prefix);
}

function updateRecurrenceDetails(prefix) {
    var select = document.getElementById(prefix + '-recurrence');
    var byDayGroup = document.getElementById(prefix + '-recurrence-byday-group');
    var monthlyGroup = document.getElementById(prefix + '-recurrence-monthly-group');
    var byMonthGroup = document.getElementById(prefix + '-recurrence-bymonth-group');
    if (!select) return;
    if (byDayGroup) {
        byDayGroup.style.display = select.value === 'WEEKLY' ? 'block' : 'none';
    }
    if (monthlyGroup) {
        monthlyGroup.style.display = (select.value === 'MONTHLY' || select.value === 'YEARLY') ? 'flex' : 'none';
    }
    if (byMonthGroup) {
        byMonthGroup.style.display = select.value === 'YEARLY' ? 'block' : 'none';
    }
}

function toggleRecurrenceEnd(prefix) {
    var select = document.getElementById(prefix + '-recurrence-end');
    var optionsDiv = document.getElementById(prefix + '-recurrence-end-options');
    var countGroup = document.getElementById(prefix + '-recurrence-count-group');
    var untilGroup = document.getElementById(prefix + '-recurrence-until-group');
    
    optionsDiv.style.display = select.value !== 'never' ? 'block' : 'none';
    countGroup.style.display = select.value === 'after' ? 'block' : 'none';
    untilGroup.style.display = select.value === 'on' ? 'block' : 'none';
}

function addReminderRow(prefix, value) {
    var container = document.getElementById(prefix + '-reminders');
    if (!container) return;
    var item = document.createElement('div');
    item.className = 'reminder-item';
    var input = document.createElement('input');
    input.type = 'number';
    input.min = '0';
    input.name = 'reminder_minutes';
    input.placeholder = '10';
    if (value !== undefined && value !== null) {
        input.value = value;
    }
    var label = document.createElement('span');
    label.textContent = 'minutes';
    var remove = document.createElement('button');
    remove.type = 'button';
    remove.className = 'btn btn-secondary btn-sm';
    remove.textContent = 'Remove';
    remove.addEventListener('click', function() {
        container.removeChild(item);
    });
    item.appendChild(input);
    item.appendChild(label);
    item.appendChild(remove);
    container.appendChild(item);
}

function setReminderList(prefix, values, defaultWhenEmpty) {
    var container = document.getElementById(prefix + '-reminders');
    if (!container) return;
    container.innerHTML = '';
    if (!values || values.length === 0) {
        if (defaultWhenEmpty) {
            addReminderRow(prefix, '10');
        }
        return;
    }
    values.forEach(function(v) {
        addReminderRow(prefix, v);
    });
}

// Import Modal
function showImportModal() {
    document.getElementById('import-modal').classList.add('show');
}

function closeImportModal() {
    document.getElementById('import-modal').classList.remove('show');
    document.getElementById('ics-file').value = '';
}

// Close modals when clicking outside
document.getElementById('create-event-modal').addEventListener('click', function(e) {
    if (e.target === this) closeCreateEventModal();
});
document.getElementById('edit-event-modal').addEventListener('click', function(e) {
    if (e.target === this) closeEditEventModal();
});
document.getElementById('import-modal').addEventListener('click', function(e) {
    if (e.target === this) closeImportModal();
});

var editTimezoneInput = document.getElementById('edit-timezone');
if (editTimezoneInput) {
    editTimezoneInput.addEventListener('input', function() {
        var deleteTz = document.getElementById('delete-timezone');
        if (deleteTz) deleteTz.value = editTimezoneInput.value || '';
    });
}
</script>

{{end}}
{{template "base" .}}
