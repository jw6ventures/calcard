name: Build and Publish

on:
  push:
    branches:
      - main
      - develop
    paths:
      - Dockerfile
      - deploy/**
      - cmd/**
      - internal/**
      - migrations/**
      - go.mod
      - go.sum
      - db.sql
      - .github/workflows/build-and-push.yaml
    tags:
      - '*'
  workflow_dispatch:
permissions:
  contents: write
  packages: write

jobs:
  docker-build-push:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    env:
      DEFAULT_BRANCH: main
      BETA_BRANCH: develop
      CHART_REPOSITORY: calcard-helm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        env:
          GHCR_USERNAME: ${{ github.actor }}
          GHCR_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "${GHCR_PASSWORD}" | docker login ghcr.io -u "${GHCR_USERNAME}" --password-stdin

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Set up Kind
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: kind

      - name: Login to GHCR for Helm
        env:
          GHCR_USERNAME: ${{ github.actor }}
          GHCR_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "${GHCR_PASSWORD}" | helm registry login ghcr.io -u "${GHCR_USERNAME}" --password-stdin

      - name: Build image for Helm test
        run: |
          set -euo pipefail
          docker build -t calcard:test .
          kind load docker-image calcard:test --name kind

      - name: Create mock OIDC discovery service
        run: |
          set -euo pipefail
          kubectl apply -f - <<'EOF'
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: oidc-mock-config
          data:
            openid-configuration: |
              {
                "authorization_endpoint": "http://oidc-mock/authorize",
                "token_endpoint": "http://oidc-mock/token",
                "userinfo_endpoint": "http://oidc-mock/userinfo"
              }
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: oidc-mock
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: oidc-mock
            template:
              metadata:
                labels:
                  app: oidc-mock
              spec:
                containers:
                  - name: nginx
                    image: nginx:1.27-alpine
                    ports:
                      - containerPort: 80
                    volumeMounts:
                      - name: config
                        mountPath: /usr/share/nginx/html/.well-known/openid-configuration
                        subPath: openid-configuration
                volumes:
                  - name: config
                    configMap:
                      name: oidc-mock-config
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: oidc-mock
          spec:
            selector:
              app: oidc-mock
            ports:
              - port: 80
                targetPort: 80
          EOF

      - name: Helm install and test
        run: |
          set -euo pipefail
          helm upgrade --install calcard-test deploy/helm/calcard \
            --set image.repository=calcard \
            --set image.tag=test \
            --set image.pullPolicy=IfNotPresent \
            --set app.baseUrl="http://calcard.local" \
            --set app.oauth.clientId="test-client" \
            --set app.oauth.clientSecret="test-client-secret" \
            --set app.oauth.discoveryUrl="http://oidc-mock.default.svc.cluster.local/.well-known/openid-configuration" \
            --set app.sessionSecret="this-is-a-very-long-session-secret-32chars" \
            --set app.db.user=postgres \
            --set app.db.password=postgres \
            --set app.db.name=app \
            --set postgres.enabled=true \
            --set postgres.persistence.enabled=false \
            --wait --timeout 5m
          helm test calcard-test --timeout 2m

      - name: Build and push image
        env:
          GHCR_OWNER: ${{ github.repository_owner }}
          GHCR_REPOSITORY: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          REF="${GITHUB_REF:-}"
          SHORT_SHA="$(echo "${GITHUB_SHA:-unknown}" | cut -c1-7)"
          IS_TAG=false
          TAG_NAME=""

          if [[ "${REF}" == refs/tags/* ]]; then
            IS_TAG=true
            TAG_NAME="${GITHUB_REF_NAME}"
            BRANCH="${DEFAULT_BRANCH}"
          else
            BRANCH="${GITHUB_REF_NAME:-${DEFAULT_BRANCH}}"
          fi

          IMAGE="ghcr.io/${GHCR_OWNER}/${GHCR_REPOSITORY}"

          TAG_ARGS=(
            -t "${IMAGE}:${BRANCH}-${SHORT_SHA}"
          )

          # Tag special channels
          if [ "${BRANCH}" = "${DEFAULT_BRANCH}" ]; then
            TAG_ARGS+=(-t "${IMAGE}:latest")
          elif [ "${BRANCH}" = "${BETA_BRANCH}" ]; then
            TAG_ARGS+=(-t "${IMAGE}:beta")
          fi

          if [ "${IS_TAG}" = true ] && [ -n "${TAG_NAME}" ]; then
            TAG_ARGS+=(-t "${IMAGE}:${TAG_NAME}")
          fi

          PRIMARY_TAG="${IMAGE}:${BRANCH}-${SHORT_SHA}"
          echo "PRIMARY_TAG=${PRIMARY_TAG}" >> "${GITHUB_ENV}"
          echo "IMAGE=${IMAGE}" >> "${GITHUB_ENV}"

          docker buildx build \
            --platform linux/amd64,linux/arm64,linux/arm/v7 \
            "${TAG_ARGS[@]}" \
            --push .

      - name: Package and push Helm chart
        env:
          GHCR_OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail
          REF="${GITHUB_REF:-}"
          SHORT_SHA="$(echo "${GITHUB_SHA:-unknown}" | cut -c1-7)"
          BASE_VERSION="1.0.0"

          if [[ "${REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF_NAME}"
            CHART_VERSION="${TAG_NAME#v}"
            APP_VERSION="${TAG_NAME#v}"
          else
            BRANCH="${GITHUB_REF_NAME:-${DEFAULT_BRANCH}}"
            SAFE_BRANCH="$(echo "${BRANCH}" | tr '[:upper:]' '[:lower:]' | tr '/' '-' | sed 's/[^0-9a-z.-]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')"
            if [ -z "${SAFE_BRANCH}" ]; then
              SAFE_BRANCH="branch"
            fi
            CHART_VERSION="${BASE_VERSION}-${SAFE_BRANCH}.${SHORT_SHA}"
            APP_VERSION="$(sed -n 's/^const version = \"\\(v[^\\\"]*\\)\"$/\\1/p' cmd/server/main.go | head -n1 | sed 's/^v//')"
            if [ -z "${APP_VERSION}" ]; then
              APP_VERSION="${SHORT_SHA}"
            fi
          fi

          helm package deploy/helm/calcard \
            --version "${CHART_VERSION}" \
            --app-version "${APP_VERSION}"

          helm push "calcard-${CHART_VERSION}.tgz" "oci://ghcr.io/${GHCR_OWNER}/${CHART_REPOSITORY}"

      - name: Extract calcard binaries
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -euo pipefail
          mkdir -p artifacts
          for platform in linux/amd64 linux/arm64 linux/arm/v7; do
            docker pull --platform "${platform}" "${PRIMARY_TAG}"
            CID="$(docker create --platform "${platform}" "${PRIMARY_TAG}")"
            filename="calcard-${platform//\//-}"
            docker cp "${CID}:/app/calcard" "artifacts/${filename}"
            docker rm "${CID}"
          done
          ls -lh artifacts

      - name: Publish binary to GitHub Release (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/calcard-*
