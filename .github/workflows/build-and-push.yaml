name: Build and Publish

on:
  push:
    branches:
      - main
      - develop
    paths:
      - Dockerfile
      - cmd/**
      - internal/**
      - migrations/**
      - go.mod
      - go.sum
      - db.sql
      - .github/workflows/build-and-push.yaml
    tags:
      - '*'
  workflow_dispatch:
permissions:
  contents: write
  packages: write

jobs:
  docker-build-push:
    runs-on: ubuntu-latest
    env:
      DEFAULT_BRANCH: main
      BETA_BRANCH: develop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        env:
          GHCR_USERNAME: ${{ github.actor }}
          GHCR_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "${GHCR_PASSWORD}" | docker login ghcr.io -u "${GHCR_USERNAME}" --password-stdin

      - name: Build and push image
        env:
          GHCR_OWNER: ${{ github.repository_owner }}
          GHCR_REPOSITORY: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          REF="${GITHUB_REF:-}"
          SHORT_SHA="$(echo "${GITHUB_SHA:-unknown}" | cut -c1-7)"
          IS_TAG=false
          TAG_NAME=""

          if [[ "${REF}" == refs/tags/* ]]; then
            IS_TAG=true
            TAG_NAME="${GITHUB_REF_NAME}"
            BRANCH="${DEFAULT_BRANCH}"
          else
            BRANCH="${GITHUB_REF_NAME:-${DEFAULT_BRANCH}}"
          fi

          IMAGE="ghcr.io/${GHCR_OWNER}/${GHCR_REPOSITORY}"

          TAG_ARGS=(
            -t "${IMAGE}:${BRANCH}-${SHORT_SHA}"
          )

          # Tag special channels
          if [ "${BRANCH}" = "${DEFAULT_BRANCH}" ]; then
            TAG_ARGS+=(-t "${IMAGE}:latest")
          elif [ "${BRANCH}" = "${BETA_BRANCH}" ]; then
            TAG_ARGS+=(-t "${IMAGE}:beta")
          fi

          if [ "${IS_TAG}" = true ] && [ -n "${TAG_NAME}" ]; then
            TAG_ARGS+=(-t "${IMAGE}:${TAG_NAME}")
          fi

          PRIMARY_TAG="${IMAGE}:${BRANCH}-${SHORT_SHA}"
          echo "PRIMARY_TAG=${PRIMARY_TAG}" >> "${GITHUB_ENV}"
          echo "IMAGE=${IMAGE}" >> "${GITHUB_ENV}"

          docker buildx build \
            --platform linux/amd64,linux/arm64,linux/arm/v7 \
            "${TAG_ARGS[@]}" \
            --push .

      - name: Extract calcard binaries
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -euo pipefail
          mkdir -p artifacts
          for platform in linux/amd64 linux/arm64 linux/arm/v7; do
            docker pull --platform "${platform}" "${PRIMARY_TAG}"
            CID="$(docker create --platform "${platform}" "${PRIMARY_TAG}")"
            filename="calcard-${platform//\//-}"
            docker cp "${CID}:/app/calcard" "artifacts/${filename}"
            docker rm "${CID}"
          done
          ls -lh artifacts

      - name: Publish binary to GitHub Release (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/calcard-*
